<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>想いマグ - OMOI-MAG AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <audio id="insert-sound" src="sounds/kacha.mp3" preload="auto"></audio>
            <audio id="music-a" src="music/side-a.mp3" preload="auto"></audio>
            <audio id="music-b" src="music/side-b.mp3" preload="auto"></audio>
        </a-assets>

        <a-marker preset="hiro" id="marker-a">
            <a-box position="0 0.5 0" material="color: red; opacity: 0.8;" scale="1.5 0.5 1"></a-box>
        </a-marker>

        <a-marker type="pattern" url="markers/marker-b.patt" id="marker-b">
            <a-entity text="value: Side B Playing; color: #0000FF; width: 4" position="0 0.5 0" rotation="-90 0 0" align="center" scale="3 3 3"></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const isAndroid = /Android/i.test(navigator.userAgent);
        const markerA = document.querySelector('#marker-a');
        const markerB = document.querySelector('#marker-b');
        const soundKacha = document.querySelector('#insert-sound');
        const musicA = document.querySelector('#music-a');
        const musicB = document.querySelector('#music-b');

        let isPlaying = false;
        let isUnlocked = false; // ← 【修正】この1行を追加しました！

        // --- A面認識時 ---
        markerA.addEventListener('markerFound', () => {
            if (!isPlaying) {
                if (isAndroid) console.log("Android detected");
                playContent(musicA);
            }
        });

        // --- B面認識時 ---
        markerB.addEventListener('markerFound', () => {
            if (!isPlaying) {
                playContent(musicB);
            }
        });

        function playContent(targetMusic) {
            isPlaying = true;
            
            // カチャッ音を先に再生する
            soundKacha.currentTime = 0;
            soundKacha.play().catch(e => console.log("Kacha Error:", e));
            
            // 少し遅らせてから音楽をスタートさせる
            setTimeout(() => {
                targetMusic.currentTime = 0;
                targetMusic.play().catch(e => console.log("Music Error:", e));
            }, 1200); // ★ここが間隔の調整です（1200 = 1.2秒後）
        }

       // 【iPhone対策】最初の画面タップ時の音声ロック解除を「完全無音」で行う
        window.addEventListener('click', () => {
            if (isUnlocked) return;

            [musicA, musicB, soundKacha].forEach(audio => {
                audio.muted = true; // 強制ミュート機能を使う
                let playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false; // 一時停止した後にミュートを解除する
                    }).catch(e => console.log("Unlock wait:", e));
                }
            });
            
            isUnlocked = true;
            console.log("Audio Unlocked Silently!");
        }, { once: true });        
    </script>
</body>
</html>
