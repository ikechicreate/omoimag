<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ÊÉ≥„ÅÑ„Éû„Ç∞ - OMOI-MAG AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <a-scene mindar-image="imageTargetSrc: targets/targets.mind; filterMinCF:0.1; filterBeta: 10" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="insert-sound" src="sounds/kacha.mp3" preload="auto"></audio>
            <audio id="music-a" src="music/side-a.mp3" preload="auto"></audio>
            <audio id="music-b" src="music/side-b.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="marker-a">
            <a-box position="0 0 0" material="color: red; opacity: 0.8;" scale="0.5 0.5 0.5"></a-box>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1" id="marker-b">
            <a-entity text="value: Side B Playing; color: #0000FF; width: 4" position="0 0 0" align="center" scale="2 2 2"></a-entity>
        </a-entity>

    </a-scene>

    <script>
        const markerA = document.querySelector('#marker-a');
        const markerB = document.querySelector('#marker-b');
        const soundKacha = document.querySelector('#insert-sound');
        const musicA = document.querySelector('#music-a');
        const musicB = document.querySelector('#music-b');

        let isUnlocked = false;
        let currentMusic = null; 
        let playTimer = null; 

        // ==========================================
        // üß≤ „ÄêÊñ∞Ë¶èËøΩÂä†„ÄëÁ£ÅÊ∞ó„Çª„É≥„Çµ„Éº„ÅÆÊ∫ñÂÇôÔºàAndroidÂ∞ÇÁî®Ôºâ
        // ==========================================
        let currentMagneticPole = null; // 'N', 'S', „Åæ„Åü„ÅØ null

        if ('Magnetometer' in window) {
            try {
                // 1ÁßíÈñì„Å´10Âõû„ÄÅÁ£ÅÂäõ„ÇíÊ∏¨ÂÆö„Åô„Çã
                const magSensor = new Magnetometer({ frequency: 10 });
                magSensor.addEventListener('reading', () => {
                    // ZËª∏ÔºàÊâãÂâç„ÉªÂ••„ÅÆÁ£ÅÂäõÔºâ„ÇíÁõ£Ë¶ñ„ÄÇÊï∞ÂÄ§„ÅÆ 100 „ÅØÁ£ÅÁü≥„ÅÆÂº∑„Åï„Å´Âøú„Åò„Å¶Ë™øÊï¥ÂèØËÉΩ„Åß„Åô„ÄÇ
                    if (magSensor.z > 100) {
                        currentMagneticPole = 'N'; // NÊ•µ„Å™„ÇâAÈù¢
                    } else if (magSensor.z < -100) {
                        currentMagneticPole = 'S'; // SÊ•µ„Å™„ÇâBÈù¢
                    } else {
                        currentMagneticPole = null; // Á£ÅÁü≥„ÅåÈÅ†„ÅÑ„ÄÅ„Åæ„Åü„ÅØÁÑ°„ÅÑ
                    }
                });
                magSensor.start();
                console.log("Á£ÅÊ∞ó„Çª„É≥„Çµ„ÉºËµ∑ÂãïÊàêÂäüÔºÅ");
            } catch (error) {
                console.log("Á£ÅÊ∞ó„Çª„É≥„Çµ„ÉºÈùûÂØæÂøúÔºàiPhone„Å™„Å©Ôºâ:", error);
            }
        }

        // ==========================================
        // üß† „ÄêÈÄ≤Âåñ„Äë„Éè„Ç§„Éñ„É™„ÉÉ„ÉâÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
        // ==========================================
        function handleTargetFound(detectedByCamera) {
            let finalDecision = detectedByCamera;

            // „ÇÇ„ÅóAndroid„ÅßÁ£ÅÊ∞ó„Çª„É≥„Çµ„Éº„ÅåN/S„Çí„Ç≠„É£„ÉÉ„ÉÅ„Åó„Å¶„ÅÑ„Çå„Å∞„ÄÅ
            // „Ç´„É°„É©„ÅåA„Å®B„ÇíË¶ãÈñìÈÅï„Åà„Å¶„ÅÑ„Å¶„ÇÇ„ÄÅÁ£ÅÁü≥„ÅÆÁ≠î„Åà„ÅßÂº∑Âà∂ÁöÑ„Å´‰∏äÊõ∏„ÅçÔºà‰øÆÊ≠£Ôºâ„Åô„ÇãÔºÅ
            if (currentMagneticPole === 'N') {
                finalDecision = 'A';
            } else if (currentMagneticPole === 'S') {
                finalDecision = 'B';
            }

            // ÊúÄÁµÇÁöÑ„Å™Ê±∫Êñ≠„Å´Âæì„Å£„Å¶Êõ≤„ÇíÈ≥¥„Çâ„Åô
            if (finalDecision === 'A') {
                if (currentMusic !== musicA) playContent(musicA, musicB);
            } else {
                if (currentMusic !== musicB) playContent(musicB, musicA);
            }
        }

        // „Ç´„É°„É©„ÅåÁµµ„ÇíË¶ã„Å§„Åë„ÅüÊôÇ„ÄÅ„Éè„Ç§„Éñ„É™„ÉÉ„ÉâÂà§ÂÆö„Å∏ÈÄÅ„Çã
        markerA.addEventListener('targetFound', () => handleTargetFound('A'));
        markerB.addEventListener('targetFound', () => handleTargetFound('B'));

        // ==========================================
        // üéµ Èü≥Ê•ΩÂÜçÁîü„Å®iPhoneÂØæÁ≠ñÔºà‰ªä„Åæ„ÅßÈÄö„ÇäÔºâ
        // ==========================================
        function playContent(targetMusic, stopMusic) {
            currentMusic = targetMusic; 
            if (playTimer) clearTimeout(playTimer);
            
            stopMusic.pause();
            stopMusic.currentTime = 0;
            
            soundKacha.currentTime = 0;
            soundKacha.play().catch(e => console.log("Kacha Error:", e));
            
            playTimer = setTimeout(() => {
                if (currentMusic === targetMusic) {
                    targetMusic.currentTime = 0;
                    targetMusic.play().catch(e => console.log("Music Error:", e));
                }
            }, 800);
        }

        window.addEventListener('click', () => {
            if (isUnlocked) return;

            [musicA, musicB, soundKacha].forEach(audio => {
                audio.muted = true; 
                let playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false; 
                    }).catch(e => console.log("Unlock wait:", e));
                }
            });
            
            isUnlocked = true;
            console.log("Audio Unlocked Silently!");
        }, { once: true });        
    </script>
</body>
</html>
