<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>想いマグ - OMOI-MAG AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <a-scene mindar-image="imageTargetSrc: targets/targets.mind; filterMinCF:0.1; filterBeta: 10" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="insert-sound" src="sounds/kacha.mp3" preload="auto"></audio>
            <audio id="music-a" src="music/side-a.mp3" preload="auto"></audio>
            <audio id="music-b" src="music/side-b.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="marker-a">
            <a-box position="0 0 0" material="color: red; opacity: 0.8;" scale="0.5 0.5 0.5"></a-box>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1" id="marker-b">
            <a-entity text="value: Side B Playing; color: #0000FF; width: 4" position="0 0 0" align="center" scale="2 2 2"></a-entity>
        </a-entity>

    </a-scene>

    <script>
        const markerA = document.querySelector('#marker-a');
        const markerB = document.querySelector('#marker-b');
        const soundKacha = document.querySelector('#insert-sound');
        const musicA = document.querySelector('#music-a');
        const musicB = document.querySelector('#music-b');

        let isUnlocked = false;
        let currentMusic = null; // 今鳴っている曲を記憶します

        // --- A面（0番の画像）が見えた時 ---
        markerA.addEventListener('targetFound', () => {
            if (currentMusic !== musicA) {
                playContent(musicA, musicB); // Aを鳴らして、Bを止める
            }
        });

        // --- B面（1番の画像）が見えた時 ---
        markerB.addEventListener('targetFound', () => {
            if (currentMusic !== musicB) {
                playContent(musicB, musicA); // Bを鳴らして、Aを止める
            }
        });

        function playContent(targetMusic, stopMusic) {
            currentMusic = targetMusic; 
            
            // もう片方の曲を一時停止して、最初に戻す
            stopMusic.pause();
            stopMusic.currentTime = 0;
            
            // カチャッ音を先に再生する
            soundKacha.currentTime = 0;
            soundKacha.play().catch(e => console.log("Kacha Error:", e));
            
            // 少し遅らせてから音楽をスタートさせる（800ミリ秒）
            setTimeout(() => {
                targetMusic.currentTime = 0;
                targetMusic.play().catch(e => console.log("Music Error:", e));
            }, 800);
        }

       // 【iPhone対策】最初の画面タップ時の音声ロック解除を「完全無音」で行う
        window.addEventListener('click', () => {
            if (isUnlocked) return;

            [musicA, musicB, soundKacha].forEach(audio => {
                audio.muted = true; 
                let playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false; 
                    }).catch(e => console.log("Unlock wait:", e));
                }
            });
            
            isUnlocked = true;
            console.log("Audio Unlocked Silently!");
        }, { once: true });        
    </script>
</body>
</html>
