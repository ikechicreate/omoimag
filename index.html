<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>想いマグ - OMOI-MAG AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <audio id="insert-sound" src="sounds/kacha.mp3" preload="auto"></audio>
            <audio id="music-a" src="music/side-a.mp3" preload="auto"></audio>
            <audio id="music-b" src="music/side-b.mp3" preload="auto"></audio>
        </a-assets>

        <a-marker preset="hiro" id="marker-a">
            <a-entity text="value: Side A Playing; color: #FF0000; width: 4" position="0 1 0" align="center" scale="3 3 3"></a-entity>
        </a-marker>

        <a-marker type="pattern" url="markers/marker-b.patt" id="marker-b">
            <a-entity text="value: Side B Playing; color: #0000FF" position="0 0.5 0" align="center"　scale="3 3 3"></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const isAndroid = /Android/i.test(navigator.userAgent);
        const markerA = document.querySelector('#marker-a');
        const markerB = document.querySelector('#marker-b');
        const soundKacha = document.querySelector('#insert-sound');
        const musicA = document.querySelector('#music-a');
        const musicB = document.querySelector('#music-b');

        let isPlaying = false;

        // --- A面認識時 ---
        markerA.addEventListener('markerFound', () => {
            if (!isPlaying) {
                if (isAndroid) console.log("Android detected");
                playContent(musicA);
            }
        });

        // --- B面認識時 ---
        markerB.addEventListener('markerFound', () => {
            if (!isPlaying) {
                playContent(musicB);
            }
        });

        function playContent(targetMusic) {
            isPlaying = true;
            
            // 【変更点】カチャッ音が鳴り終わった瞬間に音楽をスタートさせる（iPhone対策）
            soundKacha.onended = () => {
                targetMusic.currentTime = 0;
                targetMusic.play().catch(e => console.log("Music block:", e));
            };
            
            soundKacha.currentTime = 0;
            soundKacha.play().catch(e => console.log("Kacha block:", e));
        }

        // 【変更点】最初の画面タップ時の音声ロック解除を「完全無音」で行う
        window.addEventListener('click', () => {
            [musicA, musicB, soundKacha].forEach(audio => {
                audio.muted = true; // 一旦音を消す
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.muted = false; // ロック解除できたら音を戻す
                }).catch(e => console.log("Unlock wait:", e));
            });
            console.log("Audio Unlocked Silently!");
        }, { once: true });
    </script>
</body>
</html>
