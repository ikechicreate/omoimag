<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene mindar-image="imageTargetSrc: targets/targets.mind; filterMinCF:0.001; filterBeta: 100;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <audio id="insert-sound" src="sounds/kacha.mp3" preload="auto"></audio>
            <audio id="music-a" src="music/side-a.mp3" preload="auto"></audio>
            <audio id="music-b" src="music/side-b.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="marker-a">
            <a-box id="box-a" position="0 0 0.4" width="1" height="0.6" depth="0.02" material="color: #FF4081; opacity: 0.8"></a-box>
            <a-plane id="msg-a" position="0 0 0.03" width="0.8" height="0.2" color="white"></a-plane>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1" id="marker-b">
            <a-box id="box-b" position="0 0 0.4" width="1" height="0.6" depth="0.02" material="color: #2196F3; opacity: 0.8"></a-box>
            <a-plane id="msg-b" position="0 0 0.03" width="0.8" height="0.2" color="white"></a-plane>
        </a-entity>
    </a-scene>

    <script>
        // 文字画像作成（変更なし）
        function drawText(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 800; canvas.height = 200;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = "bold 60px sans-serif"; ctx.fillStyle = "#333333";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, 400, 100);
            return canvas.toDataURL();
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const msg = params.get('msg') || "想いマグへようこそ";
            const img = drawText(decodeURIComponent(msg));
            document.querySelector('#msg-a').setAttribute('src', img);
            document.querySelector('#msg-b').setAttribute('src', img);
        };

        const musicA = document.querySelector('#music-a');
        const musicB = document.querySelector('#music-b');
        const soundKacha = document.querySelector('#insert-sound');
        
        let activeSide = null;      // 今鳴っている面
        let playTimer = null;       // 音楽再生の「予約」を入れる箱
        let currentMagneticPole = null;

        // 磁気センサー
        if ('Magnetometer' in window) {
            try {
                const magSensor = new Magnetometer({ frequency: 10 });
                magSensor.addEventListener('reading', () => {
                    if (magSensor.z > 100) currentMagneticPole = 'N';
                    else if (magSensor.z < -100) currentMagneticPole = 'S';
                    else currentMagneticPole = null;
                });
                magSensor.start();
            } catch (e) {}
        }

        // --- 同時再生とアニメーション停止を防ぐ心臓部 ---
        function handleFound(detectedSide) {
            let finalSide = detectedSide;
            if (currentMagneticPole === 'N') finalSide = 'A';
            if (currentMagneticPole === 'S') finalSide = 'B';

            // すでに同じ面が実行中なら何もしない
            if (activeSide === finalSide) return;
            activeSide = finalSide;

            // 1. 【超重要】前の曲の「再生予約」が残っていたらキャンセルして消し去る！
            if (playTimer !== null) {
                clearTimeout(playTimer);
            }

            // 2. 今鳴っている音を全て強制停止
            musicA.pause(); musicA.currentTime = 0;
            musicB.pause(); musicB.currentTime = 0;

            // 3. アニメーションの強制リセット＆再実行
            const box = document.querySelector('#box-' + finalSide.toLowerCase());
            const msg = document.querySelector('#msg-' + finalSide.toLowerCase());

            // 一度アニメーションの設定を剥がす
            box.removeAttribute('animation');
            msg.removeAttribute('animation');

            // ほんの一瞬（10ミリ秒）待ってから、新しいアニメーションを注入する（これで必ず動く）
            setTimeout(() => {
                box.setAttribute('animation', 'property: position; from: 0 0 0.4; to: 0 0 0; dur: 600; easing: easeOutCubic');
                msg.setAttribute('animation', 'property: position; from: 0 0 0.03; to: 0 0.6 0.03; dur: 800; easing: easeOutBack');
            }, 10);

            // 4. カチャ音を鳴らす
            soundKacha.currentTime = 0;
            soundKacha.play().catch(e=>{});

            // 5. 新しく曲の「再生予約」を入れる
            playTimer = setTimeout(() => {
                const targetMusic = (finalSide === 'A') ? musicA : musicB;
                targetMusic.play().catch(e=>{});
            }, 600);
        }

        document.querySelector('#marker-a').addEventListener('targetFound', () => handleFound('A'));
        document.querySelector('#marker-b').addEventListener('targetFound', () => handleFound('B'));

        // 再生ロック解除
        const unlock = () => {
            [musicA, musicB, soundKacha].forEach(a => { a.play(); a.pause(); });
            document.body.removeEventListener('click', unlock);
        };
        document.body.addEventListener('click', unlock);
    </script>
</body>
</html>
